# 🔧 故障排查指南

## 问题 1：找不到 Atlas 书签文件

### 症状
```
❌ 未找到 Atlas 书签文件
请手动设置 Atlas 书签路径，可能的位置：
```

### 解决方案

#### 方法 1：手动查找 Atlas 书签位置

```bash
# 搜索可能的 Atlas 目录
find ~/Library/Application\ Support -name "*atlas*" -type d 2>/dev/null

# 或者搜索 OpenAI 相关目录
find ~/Library/Application\ Support -name "*openai*" -type d 2>/dev/null

# 搜索所有 Bookmarks 文件
find ~/Library/Application\ Support -name "Bookmarks" 2>/dev/null
```

#### 方法 2：修改脚本配置

1. 找到 Atlas 书签文件的实际位置
2. 编辑 `sync_bookmarks.py`：

```bash
nano sync_bookmarks.py
```

3. 找到这部分代码（大约在第 14-18 行）：

```python
atlas_paths = [
    Path.home() / "Library/Application Support/Atlas/Default/Bookmarks",
    Path.home() / "Library/Application Support/com.openai.atlas/Default/Bookmarks",
    Path.home() / "Library/Application Support/OpenAI/Atlas/Bookmarks",
]
```

4. 添加你找到的实际路径：

```python
atlas_paths = [
    Path.home() / "你的实际路径/Bookmarks",  # 添加这行
    Path.home() / "Library/Application Support/Atlas/Default/Bookmarks",
    # ... 其他路径
]
```

5. 保存并重新运行

---

## 问题 2：权限错误

### 症状
```
Permission denied
或者
OSError: [Errno 13] Permission denied
```

### 解决方案

```bash
# 赋予脚本执行权限
chmod +x ~/cursor/日常提问/bookmark-sync/*.sh
chmod +x ~/cursor/日常提问/bookmark-sync/*.py

# 检查书签文件权限
ls -l ~/Library/Application\ Support/Google/Chrome/Default/Bookmarks

# 如果需要，修复权限
chmod 644 ~/Library/Application\ Support/Google/Chrome/Default/Bookmarks
```

---

## 问题 3：同步后浏览器没有显示更新

### 症状
运行同步脚本显示成功，但浏览器中看不到新书签

### 解决方案

1. **完全退出浏览器**（不是关闭窗口）
   - macOS: `Cmd + Q`
   - 或在菜单栏选择"退出"

2. **等待 2-3 秒**

3. **重新打开浏览器**

4. **检查书签**

**注意：** 浏览器会缓存书签，必须完全重启才能重新读取文件。

---

## 问题 4：Python 命令找不到

### 症状
```
python3: command not found
```

### 解决方案

#### 检查 Python 是否安装
```bash
which python3
python3 --version
```

#### 如果未安装，使用 Homebrew 安装
```bash
# 安装 Homebrew（如果还没有）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 Python
brew install python3
```

---

## 问题 5：定时任务没有运行

### 症状
设置了自动同步，但书签没有自动更新

### 排查步骤

#### 1. 检查任务是否已加载
```bash
launchctl list | grep bookmarksync
```

应该看到类似输出：
```
12345  0  com.bookmarksync
```

#### 2. 查看任务日志
```bash
tail -50 ~/bookmark-sync-backups/launchd.log
tail -50 ~/bookmark-sync-backups/launchd.error.log
```

#### 3. 手动触发任务
```bash
launchctl start com.bookmarksync
```

#### 4. 重新加载任务
```bash
launchctl unload ~/Library/LaunchAgents/com.bookmarksync.plist
launchctl load ~/Library/LaunchAgents/com.bookmarksync.plist
```

#### 5. 检查 plist 文件
```bash
plutil -lint ~/Library/LaunchAgents/com.bookmarksync.plist
```

---

## 问题 6：JSON 解析错误

### 症状
```
JSONDecodeError: Expecting value
或者
json.decoder.JSONDecodeError
```

### 原因
书签文件可能已损坏

### 解决方案

#### 1. 从备份恢复
```bash
# 查看备份文件
ls -lt ~/bookmark-sync-backups/

# 恢复最近的备份
cp ~/bookmark-sync-backups/chrome_bookmarks_最新时间戳.json \
   ~/Library/Application\ Support/Google/Chrome/Default/Bookmarks
```

#### 2. 从浏览器重新导出书签
- Chrome: 书签管理器 → 导出书签为 HTML
- Atlas: 类似操作
- 然后重新导入

---

## 问题 7：同步后书签丢失

### 症状
同步后某些书签不见了

### 紧急恢复步骤

```bash
# 1. 立即停止自动同步
launchctl unload ~/Library/LaunchAgents/com.bookmarksync.plist

# 2. 查看备份
ls -lt ~/bookmark-sync-backups/

# 3. 恢复到同步前的状态
# Chrome 恢复
cp ~/bookmark-sync-backups/chrome_bookmarks_最近时间戳.json \
   ~/Library/Application\ Support/Google/Chrome/Default/Bookmarks

# Atlas 恢复  
cp ~/bookmark-sync-backups/atlas_bookmarks_最近时间戳.json \
   ~/Library/Application\ Support/Atlas/Default/Bookmarks

# 4. 重启浏览器验证
```

### 预防措施
- 脚本会自动备份，每次同步前都会创建备份
- 建议保留至少最近 10 个备份文件
- 定期手动导出书签作为额外备份

---

## 问题 8：CPU 占用过高

### 症状
同步时系统变慢

### 可能原因
书签数量非常大（数万条）

### 解决方案
```bash
# 增加同步间隔时间
nano ~/Library/LaunchAgents/com.bookmarksync.plist

# 修改 StartInterval
# 从 3600 (1小时) 改为 7200 (2小时) 或更长
```

---

## 问题 9：文件锁定错误

### 症状
```
OSError: [Errno 35] Resource temporarily unavailable
```

### 原因
浏览器正在使用书签文件

### 解决方案
1. 关闭所有 Chrome 和 Atlas 窗口
2. 等待 5 秒
3. 重新运行同步脚本

---

## 问题 10：日志文件过大

### 症状
`~/bookmark-sync-backups/` 占用空间过大

### 清理方法

```bash
# 查看目录大小
du -sh ~/bookmark-sync-backups/

# 只保留最近 30 天的备份
find ~/bookmark-sync-backups/ -name "*.json" -mtime +30 -delete

# 清理旧日志（保留最近 1000 行）
tail -1000 ~/bookmark-sync-backups/sync.log > /tmp/sync.log.tmp
mv /tmp/sync.log.tmp ~/bookmark-sync-backups/sync.log
```

---

## 获取帮助

如果以上方法都无法解决问题：

1. **查看完整日志**
   ```bash
   cat ~/bookmark-sync-backups/sync.log
   ```

2. **运行诊断命令**
   ```bash
   python3 -c "
   from pathlib import Path
   chrome = Path.home() / 'Library/Application Support/Google/Chrome/Default/Bookmarks'
   print(f'Chrome 书签存在: {chrome.exists()}')
   print(f'Chrome 书签大小: {chrome.stat().st_size if chrome.exists() else 0} bytes')
   "
   ```

3. **手动备份当前状态**
   ```bash
   mkdir -p ~/bookmark-backup-emergency
   cp ~/Library/Application\ Support/Google/Chrome/Default/Bookmarks \
      ~/bookmark-backup-emergency/chrome-$(date +%Y%m%d-%H%M%S).json
   ```

4. **联系开发者**，提供：
   - 错误日志内容
   - 系统信息 (`sw_vers`)
   - Python 版本 (`python3 --version`)
   - 书签文件大小

---

## 预防性检查清单

定期运行这些检查，确保同步正常：

- [ ] 检查定时任务状态 (`launchctl list | grep bookmarksync`)
- [ ] 查看最近的同步日志 (`tail ~/bookmark-sync-backups/sync.log`)
- [ ] 验证备份文件存在 (`ls ~/bookmark-sync-backups/`)
- [ ] 确认磁盘空间充足 (`df -h ~`)
- [ ] 测试手动同步 (`./run_sync.sh`)

---

**记住：脚本会自动备份，即使出错也可以恢复！** 🛡️

